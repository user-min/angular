tinymce.PluginManager.add('formathtml', function(editor, url) {
  var pluginName = 'html格式化';
  window.formatData={}; //扔外部公共变量，也可以扔一个自定义的位置

  var baseURL=tinymce.baseURL;
  var iframe = baseURL+'/plugins/formathtml/format.html';
  var openDialog = function() {
    return editor.windowManager.openUrl({
      title: pluginName,
      url: iframe,
      buttons: [
        {
          type: 'cancel',
          text: 'Close'
        },
        {
          type: 'custom',
          text: 'Save',
          primary: true
        }
      ],
      onAction: function(api, details) {
        var style = ' style="font-size:' + formatData.data.fontSize + 'px;font-family:' + formatData.data.fontFamily + ';"';
        var style2 = ' style="width:100%;height:500px;"';
        var content = tinymce.activeEditor.getContent();
        console.log('content', content.length);
        if (content.length === 0) {
          api.close();
          return;
        }

        if (!(content.indexOf('iframe') !== -1)) {
          var div = document.createElement('div');
          div.innerHTML = content;
          var elementList = div.getElementsByTagName('*');
          console.log('elementList', elementList);

          var regEx = /style\s*?=\s*?(['"])[\s\S]*?\1/g;
          for (var index = 0; index < elementList.length; index++) {
            if (elementList[index].tagName!='iframe' && elementList[index].tagName!='img') {
              var tempHtml = elementList[index].outerHTML;
              tempHtml = tempHtml.replace(regEx, '');
              // console.log('tempHtml', tempHtml);
              elementList[index].outerHTML = tempHtml;
              elementList[index].style.fontSize = formatData.data.fontSize;
              elementList[index].style.fontFamily = formatData.data.fontFamily;
              // console.log(elementList[index]);
            }
          }
          var result = div.outerHTML;
          console.log('result', result);
          tinymce.activeEditor.resetContent(result);
          // // 匹配时去掉特殊标签 img iframe
          //
          // var regEx1 = /<(?!img)(?!iframe).*style\s*?=\s*?(['"])[\s\S]*?\1/g; // 去除style=""
          // var regEx2 = /<(?!img)(?!iframe).*style/g; // 去除style
          // var regEx3 = /<(?!img)(?!iframe)[^(/>)]+/g; // 匹配所有标签
          // var newContent1 = content.replace(regEx1, '');
          // newContent1 = newContent1.replace(regEx2, '');
          // console.log('newContent1', newContent1);
          // var arr = newContent1.match(regEx3); // 找到所有起始标签
          // for (var i = 0; i < arr.length; i++) {  // 标签去重
          //   for (var j = i + 1; j < arr.length; j++) {
          //     if (arr[i] == arr[j]) {
          //       arr.splice(j, 1);
          //       j--;
          //     }
          //   }
          // }
          // console.log('arr', arr);
          // for (var index = 0; index < arr.length; index ++) {
          //   if (arr[index].indexOf('iframe') === -1) {
          //     newContent1 = newContent1.replaceAll(arr[index],arr[index] + style);
          //   }
          // }
          // console.log('newContent1最终结果', newContent1);
          // tinymce.activeEditor.resetContent(newContent1);
        }
        api.close();
      }
    });
  };

  editor.ui.registry.getAll().icons.axupimgs || editor.ui.registry.addIcon('formathtml','<svg t="1619418953940" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1595" width="24" height="24"><path d="M212.992 526.336 212.992 526.336 212.992 526.336 215.04 526.336 212.992 526.336Z" p-id="1596"></path><path d="M784.384 186.368 239.616 186.368c-90.112 0-163.84 73.728-163.84 163.84l0 327.68c0 90.112 73.728 163.84 163.84 163.84l544.768 0c90.112 0 163.84-73.728 163.84-163.84l0-327.68C948.224 260.096 874.496 186.368 784.384 186.368zM301.056 606.208 266.24 606.208l0-106.496L172.032 499.712l0 106.496L135.168 606.208 135.168 372.736l34.816 0 0 96.256L266.24 468.992l0-96.256 34.816 0L301.056 606.208zM487.424 403.456l-63.488 0 0 202.752L389.12 606.208l0-202.752L327.68 403.456l0-30.72 161.792 0L489.472 403.456zM702.464 606.208l-6.144-98.304c-2.048-30.72-4.096-67.584-2.048-96.256l0 0c-6.144 26.624-16.384 57.344-26.624 86.016l-34.816 106.496-26.624 0-32.768-104.448c-10.24-30.72-18.432-61.44-22.528-88.064l0 0c0 28.672-2.048 65.536-4.096 98.304l-6.144 96.256-32.768 0 16.384-233.472 43.008 0 32.768 102.4c8.192 28.672 16.384 55.296 20.48 79.872l0 0c6.144-24.576 12.288-51.2 22.528-79.872l32.768-102.4 45.056 0L737.28 606.208 702.464 606.208zM905.216 606.208l-124.928 0L780.288 372.736l34.816 0 0 202.752 90.112 0L905.216 606.208z" p-id="1597"></path></svg>');


  // 注册一个工具栏按钮名称
  editor.ui.registry.addButton('formathtml', {
    icon: 'formathtml',
    tooltip: pluginName,
    onAction: function() {
      openDialog();
    }
  });

  // 注册一个菜单项名称 menu/menubar
  editor.ui.registry.addMenuItem('formathtml', {
    icon: 'formathtml',
    text: 'html格式化',
    onAction: function() {
      openDialog();
    }
  });

  return {
    getMetadata: function () {
      return  {
        //插件名和链接会显示在“帮助”→“插件”→“已安装的插件”中
        name: pluginName,//插件名称
        // url: "http://tinymce.ax-z.cn/more-plugins/axupimgs.php",
        url: 'http://tinymce.ax-z.cn/advanced/creating-a-plugin.php' //作者网址
      };
    }
  };
});
